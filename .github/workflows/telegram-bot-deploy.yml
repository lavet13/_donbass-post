name: Deploy Telegram Bot

on:
  push:
    branches: ["main"]
    paths:
      - "apps/telegram-bot/**"
      - "packages/**"
      - ".github/workflows/telegram-bot-deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          mkdir -p apps/telegram-bot
          cat > apps/telegram-bot/.env << EOF
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          USE_WEBHOOK=${{ secrets.USE_WEBHOOK }}
          WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
          PORT=3000
          NODE_ENV=production
          EOF

      - name: Deploy with rsync
        uses: burnett01/rsync-deployment@6.0.0
        with:
          switches: -avzr --delete --exclude='node_modules' --exclude='dist' --exclude='.git' --exclude='.turbo' --exclude='apps/web' --exclude='apps/telegram-mini-app' --exclude='packages/forms' --exclude='packages/ui' --exclude='.DS_Store' --exclude='*.log' --exclude='logs'
          path: ./
          remote_path: ~/telegram-bot
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USERNAME }}
          remote_key: ${{ secrets.VPS_SSH_KEY }}
          remote_port: ${{ secrets.VPS_SSH_PORT }}

      - name: Build and start
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            cd ~/telegram-bot

            # Install all dependencies
            yarn install --frozen-lockfile

            # Build telegram bot
            yarn workspace @donbass-post/tg-bot build

            # Navigate to bot directory
            cd apps/telegram-bot
            mkdir -p logs

            # Restart PM2
            pm2 stop telegram-bot || true
            pm2 delete telegram-bot || true
            pm2 start ecosystem.config.cjs --env production
            pm2 save

            # Verify
            pm2 status telegram-bot
            pm2 logs telegram-bot --lines 20 --nostream

      - name: Health check
        run: sleep 5

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            if pm2 status telegram-bot | grep -q "online"; then
              echo "✅ Bot deployed successfully!"
              pm2 logs telegram-bot --lines 10 --nostream
            else
              echo "❌ Deployment failed!"
              pm2 logs telegram-bot --lines 50 --nostream
              exit 1
            fi
