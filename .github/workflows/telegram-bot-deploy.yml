name: Deploy Telegram Bot

on:
  push:
    branches: ["main"]
    paths:
      - "apps/telegram-bot/**"
      - "packages/**"
      - ".github/workflows/telegram-bot-deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deploy

          # Use rsync to copy monorepo, excluding unnecessary files
          rsync -av \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.git' \
            --exclude='.turbo' \
            --exclude='.env*' \
            --exclude='apps/web' \
            --exclude='apps/telegram-mini-app' \
            --exclude='packages/forms' \
            --exclude='packages/ui' \
            --exclude='.DS_Store' \
            --exclude='*.log' \
            --exclude='logs' \
            --exclude='deploy' \
            ./ deploy/

          # Create .env file for telegram-bot
          cat > deploy/apps/telegram-bot/.env << EOF
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          USE_WEBHOOK=true
          WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
          PORT=3000
          NODE_ENV=production
          EOF

      - name: Clean VPS directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            # Remove old deployment (keeps a clean slate)
            rm -rf ~/telegram-bot/*
            mkdir -p ~/telegram-bot

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "deploy/*"
          target: "~/telegram-bot"
          strip_components: 1

      - name: Build and start
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            cd ~/telegram-bot

            # Install all dependencies
            yarn install --frozen-lockfile

            # Build telegram bot
            yarn workspace @donbass-post/tg-bot build

            # Navigate to bot directory
            cd apps/telegram-bot
            mkdir -p logs

            # Restart PM2
            pm2 stop telegram-bot || true
            pm2 delete telegram-bot || true
            pm2 start ecosystem.config.cjs --env production
            pm2 save

            # Verify
            pm2 status telegram-bot
            pm2 logs telegram-bot --lines 20 --nostream

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            if pm2 status telegram-bot | grep -q "online"; then
              echo "✅ Bot deployed successfully!"
              pm2 logs telegram-bot --lines 10 --nostream
            else
              echo "❌ Deployment failed!"
              pm2 logs telegram-bot --lines 50 --nostream
              exit 1
            fi
