name: Deploy Telegram Bot

on:
  push:
    branches: ["main"]
    paths:
      - "apps/telegram-bot/**"
      - ".github/workflows/telegram-bot-deploy.yml"
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "yarn"

      # 3. Install dependencies
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # 4. Build the project
      - name: Build telegram bot
        run: yarn workspace @donbass-post/tg-bot build

      # 5. Prepare deployment files
      - name: Create deployment package
        run: |
          mkdir -p apps/telegram-bot/deploy

          # Copy built output + package.json
          cp -r apps/telegram-bot/dist apps/telegram-bot/deploy/
          cp apps/telegram-bot/ecosystem.config.cjs apps/telegram-bot/deploy/

           # Create minimal package.json (NO dependencies needed!)
          cd apps/telegram-bot/deploy
          cat > package.json << 'PKGJSON'
          {
            "name": "@donbass-post/tg-bot",
            "private": true,
            "version": "0.0.0",
            "type": "module"
          }
          PKGJSON

          cat > .env << EOF
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          USE_WEBHOOK=true
          WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
          PORT=3000
          NODE_ENV=production
          EOF

      # 6. Deploy to VPS
      - name: Prepare VPS directories
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            mkdir -p ~/telegram-bot

            if [ -d ~/telegram-bot/current ]; then
              mv ~/telegram-bot/current ~/telegram-bot/backup_$(date +%Y%m%d_%H%M%S)
              ls -dt ~/telegram-bot/backup_* | tail -n +4 | xargs rm -rf
            fi

            mkdir -p ~/telegram-bot/current

      # 7. Copy files to VPS
      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "apps/telegram-bot/deploy/*"
          target: "~/telegram-bot/current"
          strip_components: 3

      # 8. Install dependencies and restart with PM2
      - name: Install deps & (re)start with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            cd ~/telegram-bot/current

            # Ensure logs dir exists (ecosystem config)
            mkdir -p logs

            pm2 stop telegram-bot || true
            pm2 delete telegram-bot || true

            pm2 start ecosystem.config.cjs --env production

            # Optional upgrade: use reload for zero-downtime if your app supports it
            # pm2 reload ecosystem.config.cjs --env production   # try this later

            pm2 save
            pm2 status telegram-bot
            pm2 logs telegram-bot --lines 40 --nostream

      # 9. Health check
      - name: Wait for bot to start
        run: sleep 15

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            if pm2 status telegram-bot | grep -q "online"; then
              echo "✅ Bot is running successfully!"
              pm2 logs telegram-bot --lines 10 --nostream
            else
              echo "❌ Bot failed to start!"
              pm2 logs telegram-bot --lines 50 --nostream
              exit 1
            fi
